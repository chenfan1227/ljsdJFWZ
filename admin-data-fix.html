<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå°æ•°æ®ä¿®å¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 100%;
            text-align: center;
        }
        
        .header {
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
            min-width: 200px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        .btn.danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }
        
        .log {
            background: #f1f5f9;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ ç®¡ç†åå°æ•°æ®ä¿®å¤å·¥å…·</h1>
            <p>è§£å†³æ•°æ®åŠ è½½å¤±è´¥å’Œè®¤è¯é—®é¢˜</p>
        </div>
        
        <div class="actions">
            <button class="btn success" onclick="fixAuth()">ğŸ”‘ ä¿®å¤è®¤è¯</button>
            <button class="btn" onclick="testAPI()">ğŸŒ æµ‹è¯•API</button>
            <button class="btn" onclick="testData()">ğŸ“Š æµ‹è¯•æ•°æ®</button>
            <button class="btn danger" onclick="resetAll()">ğŸ”„ å®Œå…¨é‡ç½®</button>
        </div>
        
        <div class="log" id="logArea">
            <div>ğŸš€ å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹ä¿®å¤...</div>
        </div>
        
        <div style="margin-top: 20px;">
            <button class="btn" onclick="goToAdmin()">ğŸ  è¿”å›ç®¡ç†åå°</button>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://192.168.1.29:3001/api';
        
        function log(message) {
            const logArea = document.getElementById('logArea');
            const time = new Date().toLocaleTimeString();
            logArea.innerHTML += `<div>[${time}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
        }
        
        async function fixAuth() {
            clearLog();
            log('ğŸ”§ å¼€å§‹ä¿®å¤è®¤è¯é—®é¢˜...');
            
            try {
                // ç¬¬1æ­¥ï¼šæ¸…ç†æ—§è®¤è¯æ•°æ®
                log('ğŸ—‘ï¸ æ¸…ç†æ—§è®¤è¯æ•°æ®...');
                const keys = ['adminAuth', 'adminToken', 'adminUser', 'auth_data', 'session_data'];
                keys.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                
                // ç¬¬2æ­¥ï¼šè·å–æ–°Token
                log('ğŸ“ è·å–æ–°çš„è®¤è¯Token...');
                const loginResponse = await fetch(`${API_BASE_URL}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                
                if (!loginResponse.ok) {
                    throw new Error('ç™»å½•å¤±è´¥: ' + loginResponse.status);
                }
                
                const loginData = await loginResponse.json();
                log('âœ… ç™»å½•æˆåŠŸï¼Token: ' + loginData.token.substring(0, 30) + '...');
                
                // ç¬¬3æ­¥ï¼šä¿å­˜è®¤è¯ä¿¡æ¯ï¼ˆå¤šç§æ ¼å¼å…¼å®¹ï¼‰
                log('ğŸ’¾ ä¿å­˜è®¤è¯ä¿¡æ¯...');
                const authInfo = {
                    token: loginData.token,
                    user: loginData.admin,
                    admin: loginData.admin,
                    timestamp: Date.now(),
                    loginTime: new Date().toISOString()
                };
                
                // å¤šé‡ä¿å­˜ç¡®ä¿å…¼å®¹æ€§
                localStorage.setItem('adminAuth', JSON.stringify(authInfo));
                localStorage.setItem('adminToken', loginData.token);
                localStorage.setItem('adminUser', JSON.stringify(loginData.admin));
                
                sessionStorage.setItem('adminAuth', JSON.stringify(authInfo));
                sessionStorage.setItem('adminToken', loginData.token);
                
                log('ğŸ’¾ è®¤è¯ä¿¡æ¯å·²ä¿å­˜ï¼');
                log('ğŸ‰ è®¤è¯ä¿®å¤å®Œæˆï¼ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨ç®¡ç†åå°äº†ã€‚');
                
            } catch (error) {
                log('âŒ è®¤è¯ä¿®å¤å¤±è´¥: ' + error.message);
                log('ğŸ”§ è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚');
            }
        }
        
        async function testAPI() {
            clearLog();
            log('ğŸŒ æµ‹è¯•APIè¿æ¥...');
            
            try {
                // æµ‹è¯•å¥åº·æ£€æŸ¥
                log('ğŸ“¡ æµ‹è¯•APIå¥åº·çŠ¶æ€...');
                const healthResponse = await fetch(`${API_BASE_URL}/health`);
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    log('âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡: ' + healthData.message);
                } else {
                    throw new Error('APIå¥åº·æ£€æŸ¥å¤±è´¥');
                }
                
                // æµ‹è¯•è®¤è¯
                const token = localStorage.getItem('adminToken');
                if (!token) {
                    log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°Tokenï¼Œè¯·å…ˆç‚¹å‡»"ä¿®å¤è®¤è¯"');
                    return;
                }
                
                log('ğŸ”‘ æµ‹è¯•Tokenæœ‰æ•ˆæ€§...');
                const dashboardResponse = await fetch(`${API_BASE_URL}/admin/dashboard`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (dashboardResponse.ok) {
                    const dashboardData = await dashboardResponse.json();
                    log('âœ… Tokenæœ‰æ•ˆï¼ŒAPIå“åº”æ­£å¸¸');
                    log('ğŸ“Š è·å–åˆ°æ•°æ®: ' + JSON.stringify(dashboardData).substring(0, 100) + '...');
                } else {
                    log('âŒ Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸï¼ŒçŠ¶æ€ç : ' + dashboardResponse.status);
                    log('ğŸ’¡ å»ºè®®ç‚¹å‡»"ä¿®å¤è®¤è¯"é‡æ–°è·å–Token');
                }
                
            } catch (error) {
                log('âŒ APIæµ‹è¯•å¤±è´¥: ' + error.message);
                log('ğŸ”§ è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œåç«¯æœåŠ¡çŠ¶æ€');
            }
        }
        
        async function testData() {
            clearLog();
            log('ğŸ“Š æµ‹è¯•æ•°æ®è·å–...');
            
            const token = localStorage.getItem('adminToken');
            if (!token) {
                log('âš ï¸ æ²¡æœ‰Tokenï¼Œè¯·å…ˆä¿®å¤è®¤è¯');
                return;
            }
            
            try {
                const endpoints = [
                    '/admin/dashboard',
                    '/admin/admob',
                    '/admin/revenue/report'
                ];
                
                for (const endpoint of endpoints) {
                    log(`ğŸ” æµ‹è¯• ${endpoint}...`);
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        log(`âœ… ${endpoint} æ•°æ®è·å–æˆåŠŸ`);
                    } else {
                        log(`âŒ ${endpoint} è·å–å¤±è´¥: ${response.status}`);
                    }
                }
                
                log('ğŸ¯ æ•°æ®æµ‹è¯•å®Œæˆï¼');
                
            } catch (error) {
                log('âŒ æ•°æ®æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }
        
        function resetAll() {
            if (confirm('ç¡®å®šè¦å®Œå…¨é‡ç½®å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ã€‚')) {
                clearLog();
                log('ğŸ”„ æ‰§è¡Œå®Œå…¨é‡ç½®...');
                
                localStorage.clear();
                sessionStorage.clear();
                
                log('ğŸ—‘ï¸ æ‰€æœ‰æœ¬åœ°æ•°æ®å·²æ¸…é™¤');
                log('ğŸ”§ è¯·ç‚¹å‡»"ä¿®å¤è®¤è¯"é‡æ–°è®¾ç½®');
            }
        }
        
        function goToAdmin() {
            window.open('admin-dashboard.html', '_self');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            setTimeout(() => {
                log('ğŸ” è‡ªåŠ¨æ£€æŸ¥è®¤è¯çŠ¶æ€...');
                const token = localStorage.getItem('adminToken');
                const adminAuth = localStorage.getItem('adminAuth');
                
                if (token && adminAuth) {
                    log('âœ… æ‰¾åˆ°è®¤è¯æ•°æ®');
                    log('ğŸ’¡ å¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·ç‚¹å‡»"æµ‹è¯•API"æˆ–"ä¿®å¤è®¤è¯"');
                } else {
                    log('âš ï¸ æœªæ‰¾åˆ°è®¤è¯æ•°æ®');
                    log('ğŸ’¡ å»ºè®®ç‚¹å‡»"ä¿®å¤è®¤è¯"');
                }
            }, 500);
        };
    </script>
</body>
</html>

<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå°æ•°æ®ä¿®å¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 100%;
            text-align: center;
        }
        
        .header {
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
            min-width: 200px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        .btn.danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }
        
        .log {
            background: #f1f5f9;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ ç®¡ç†åå°æ•°æ®ä¿®å¤å·¥å…·</h1>
            <p>è§£å†³æ•°æ®åŠ è½½å¤±è´¥å’Œè®¤è¯é—®é¢˜</p>
        </div>
        
        <div class="actions">
            <button class="btn success" onclick="fixAuth()">ğŸ”‘ ä¿®å¤è®¤è¯</button>
            <button class="btn" onclick="testAPI()">ğŸŒ æµ‹è¯•API</button>
            <button class="btn" onclick="testData()">ğŸ“Š æµ‹è¯•æ•°æ®</button>
            <button class="btn danger" onclick="resetAll()">ğŸ”„ å®Œå…¨é‡ç½®</button>
        </div>
        
        <div class="log" id="logArea">
            <div>ğŸš€ å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹ä¿®å¤...</div>
        </div>
        
        <div style="margin-top: 20px;">
            <button class="btn" onclick="goToAdmin()">ğŸ  è¿”å›ç®¡ç†åå°</button>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://192.168.1.29:3001/api';
        
        function log(message) {
            const logArea = document.getElementById('logArea');
            const time = new Date().toLocaleTimeString();
            logArea.innerHTML += `<div>[${time}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
        }
        
        async function fixAuth() {
            clearLog();
            log('ğŸ”§ å¼€å§‹ä¿®å¤è®¤è¯é—®é¢˜...');
            
            try {
                // ç¬¬1æ­¥ï¼šæ¸…ç†æ—§è®¤è¯æ•°æ®
                log('ğŸ—‘ï¸ æ¸…ç†æ—§è®¤è¯æ•°æ®...');
                const keys = ['adminAuth', 'adminToken', 'adminUser', 'auth_data', 'session_data'];
                keys.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                
                // ç¬¬2æ­¥ï¼šè·å–æ–°Token
                log('ğŸ“ è·å–æ–°çš„è®¤è¯Token...');
                const loginResponse = await fetch(`${API_BASE_URL}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                
                if (!loginResponse.ok) {
                    throw new Error('ç™»å½•å¤±è´¥: ' + loginResponse.status);
                }
                
                const loginData = await loginResponse.json();
                log('âœ… ç™»å½•æˆåŠŸï¼Token: ' + loginData.token.substring(0, 30) + '...');
                
                // ç¬¬3æ­¥ï¼šä¿å­˜è®¤è¯ä¿¡æ¯ï¼ˆå¤šç§æ ¼å¼å…¼å®¹ï¼‰
                log('ğŸ’¾ ä¿å­˜è®¤è¯ä¿¡æ¯...');
                const authInfo = {
                    token: loginData.token,
                    user: loginData.admin,
                    admin: loginData.admin,
                    timestamp: Date.now(),
                    loginTime: new Date().toISOString()
                };
                
                // å¤šé‡ä¿å­˜ç¡®ä¿å…¼å®¹æ€§
                localStorage.setItem('adminAuth', JSON.stringify(authInfo));
                localStorage.setItem('adminToken', loginData.token);
                localStorage.setItem('adminUser', JSON.stringify(loginData.admin));
                
                sessionStorage.setItem('adminAuth', JSON.stringify(authInfo));
                sessionStorage.setItem('adminToken', loginData.token);
                
                log('ğŸ’¾ è®¤è¯ä¿¡æ¯å·²ä¿å­˜ï¼');
                log('ğŸ‰ è®¤è¯ä¿®å¤å®Œæˆï¼ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨ç®¡ç†åå°äº†ã€‚');
                
            } catch (error) {
                log('âŒ è®¤è¯ä¿®å¤å¤±è´¥: ' + error.message);
                log('ğŸ”§ è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚');
            }
        }
        
        async function testAPI() {
            clearLog();
            log('ğŸŒ æµ‹è¯•APIè¿æ¥...');
            
            try {
                // æµ‹è¯•å¥åº·æ£€æŸ¥
                log('ğŸ“¡ æµ‹è¯•APIå¥åº·çŠ¶æ€...');
                const healthResponse = await fetch(`${API_BASE_URL}/health`);
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    log('âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡: ' + healthData.message);
                } else {
                    throw new Error('APIå¥åº·æ£€æŸ¥å¤±è´¥');
                }
                
                // æµ‹è¯•è®¤è¯
                const token = localStorage.getItem('adminToken');
                if (!token) {
                    log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°Tokenï¼Œè¯·å…ˆç‚¹å‡»"ä¿®å¤è®¤è¯"');
                    return;
                }
                
                log('ğŸ”‘ æµ‹è¯•Tokenæœ‰æ•ˆæ€§...');
                const dashboardResponse = await fetch(`${API_BASE_URL}/admin/dashboard`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (dashboardResponse.ok) {
                    const dashboardData = await dashboardResponse.json();
                    log('âœ… Tokenæœ‰æ•ˆï¼ŒAPIå“åº”æ­£å¸¸');
                    log('ğŸ“Š è·å–åˆ°æ•°æ®: ' + JSON.stringify(dashboardData).substring(0, 100) + '...');
                } else {
                    log('âŒ Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸï¼ŒçŠ¶æ€ç : ' + dashboardResponse.status);
                    log('ğŸ’¡ å»ºè®®ç‚¹å‡»"ä¿®å¤è®¤è¯"é‡æ–°è·å–Token');
                }
                
            } catch (error) {
                log('âŒ APIæµ‹è¯•å¤±è´¥: ' + error.message);
                log('ğŸ”§ è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œåç«¯æœåŠ¡çŠ¶æ€');
            }
        }
        
        async function testData() {
            clearLog();
            log('ğŸ“Š æµ‹è¯•æ•°æ®è·å–...');
            
            const token = localStorage.getItem('adminToken');
            if (!token) {
                log('âš ï¸ æ²¡æœ‰Tokenï¼Œè¯·å…ˆä¿®å¤è®¤è¯');
                return;
            }
            
            try {
                const endpoints = [
                    '/admin/dashboard',
                    '/admin/admob',
                    '/admin/revenue/report'
                ];
                
                for (const endpoint of endpoints) {
                    log(`ğŸ” æµ‹è¯• ${endpoint}...`);
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        log(`âœ… ${endpoint} æ•°æ®è·å–æˆåŠŸ`);
                    } else {
                        log(`âŒ ${endpoint} è·å–å¤±è´¥: ${response.status}`);
                    }
                }
                
                log('ğŸ¯ æ•°æ®æµ‹è¯•å®Œæˆï¼');
                
            } catch (error) {
                log('âŒ æ•°æ®æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }
        
        function resetAll() {
            if (confirm('ç¡®å®šè¦å®Œå…¨é‡ç½®å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ã€‚')) {
                clearLog();
                log('ğŸ”„ æ‰§è¡Œå®Œå…¨é‡ç½®...');
                
                localStorage.clear();
                sessionStorage.clear();
                
                log('ğŸ—‘ï¸ æ‰€æœ‰æœ¬åœ°æ•°æ®å·²æ¸…é™¤');
                log('ğŸ”§ è¯·ç‚¹å‡»"ä¿®å¤è®¤è¯"é‡æ–°è®¾ç½®');
            }
        }
        
        function goToAdmin() {
            window.open('admin-dashboard.html', '_self');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            setTimeout(() => {
                log('ğŸ” è‡ªåŠ¨æ£€æŸ¥è®¤è¯çŠ¶æ€...');
                const token = localStorage.getItem('adminToken');
                const adminAuth = localStorage.getItem('adminAuth');
                
                if (token && adminAuth) {
                    log('âœ… æ‰¾åˆ°è®¤è¯æ•°æ®');
                    log('ğŸ’¡ å¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·ç‚¹å‡»"æµ‹è¯•API"æˆ–"ä¿®å¤è®¤è¯"');
                } else {
                    log('âš ï¸ æœªæ‰¾åˆ°è®¤è¯æ•°æ®');
                    log('ğŸ’¡ å»ºè®®ç‚¹å‡»"ä¿®å¤è®¤è¯"');
                }
            }, 500);
        };
    </script>
</body>
</html>
